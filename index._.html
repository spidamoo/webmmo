<!DOCTYPE html>
<html>
    <head>
        <title>webmmo</title>
        <script src="/js/jquery-3.2.1.min.js"></script>
        <script src="/js/easeljs-0.8.2.min.js"></script>
        <script>
            var socket;
            var zone_type;
            var ships = {};
            var people = {};
            var objects = [];
            var my_id;
            var control = {};
            var control_allowed = true;

            $(function() {
                console.log(window);
                var ws_path = "ws://" + window.location.host + "/_hippie/ws";
                socket = new WebSocket(ws_path);
                socket.onopen = function() {
                    $('#connection-status').text("Connected");
                };
                socket.onerror = function() {
                    $('#connection-status').text("Error");
                }
                socket.onclose = function() {
                    $('#connection-status').text("Disconnected");
                }
                socket.onmessage = function(e) {
                    var data = JSON.parse(e.data);
                    console.log(e.data, data, control);
                    switch(data.type) {
                        case 'id':
                            my_id = data.id;
                        break;
                        case 'zone':
                            ships = {};
                            people = {};
                            objects = [];
                            ship_shapes = {};
                            person_shapes = {};
                            objects_container.removeAllChildren();
                            ships_container.removeAllChildren();
                            people_container.removeAllChildren();
                            control = {
                                right:  false,
                                left:   false,
                                up:     false,
                                down:   false,
                                move:   0,
                            };
                            zone_type = data.zone;
                            if (zone_type == 'space') {
                                people_container.visible = false;
                                ships_container.visible  = true;
                            }
                            else if (zone_type == 'station') {
                                people_container.visible = true;
                                ships_container.visible  = false;
                            }
                        break;
                        case 'ships':
                            if (data.replace) {
                                ships = data.ships;
                            }
                            else {
                                Object.assign(ships, data.ships);
                            }
                        break;
                        case 'ship_destroyed':
                            delete ships[data.id];
                        case 'people':
                            if (data.replace) {
                                people = data.people;
                            }
                            else {
                                Object.assign(people, data.people);
                            }
                        break;
                        case 'person_destroyed':
                            delete people[data.id];
                        case 'objects':
                            objects = data.objects;
                            draw_objects();
                        break;
                        case 'person_destroyed':
                            delete people[data.id];
                        break;
                    }
                };

                init_game('game-canvas');
            });
             
            function send_msg(message) {
                console.log('send', message);
                socket.send( JSON.stringify(message) );
            }

            function update_ships(dt) {
                // console.log(ships);
                Object.entries(ships).forEach(function(o) {
                    [id, ship_data] = o;

                    if (dt) {
                        ship_data.x += ship_data.dx * dt;
                        ship_data.y += ship_data.dy * dt;
                        if (ship_data.da !== null) {
                            ship_data.a += ship_data.da * dt;
                        }
                    }

                    var shape = get_ship_shape(id, ship_data);
                    shape.x        = ship_data.x;
                    shape.y        = ship_data.y;
                    if (ship_data.a !== null) {
                        shape.rotation = ship_data.a * 180 / 3.14;
                    }
                    else {
                        shape.rotation = ship_data.direction * 45 - 45;
                    }
                });

                Object.keys(ship_shapes).forEach(function(id) {
                    if (ships[id] === undefined) {
                        ships_container.removeChild(ship_shapes[id]);
                        delete ship_shapes[id];
                    }
                });
            }
            function update_people(dt) {
                for (var id in people) {
                    var person = people[id];

                    person.dy += 500 * dt;

                    if (dt) {
                        person.x += person.dx * dt;
                        person.y += person.dy * dt;
                    }

                    for (var i in objects) {
                        var object = objects[i];
                        if (object.type == 'floor') {
                            if (
                                person.dy > 0 &&
                                person.x > object.geometry.left && person.x < object.geometry.right &&
                                person.y >= object.geometry.y   && person.y < object.geometry.y + 10
                            ) {
                                person.dy = 0;
                                person.y  = object.geometry.y;
                            }
                        }
                    }

                    var shape = get_person_shape(id, person);
                    shape.x        = person.x;
                    shape.y        = person.y;
                };

                Object.keys(person_shapes).forEach(function(id) {
                    if (people[id] === undefined) {
                        people_container.removeChild(person_shapes[id]);
                        delete person_shapes[id];
                    }
                });
            }

            function update_control(dt) {
                if (zone_type == 'space') {
                    update_ship_control(dt);
                }
                else if (zone_type == 'station') {
                    update_person_control(dt);
                }
            }
            function update_ship_control(dt) {
                // console.log(rotating, control);
                if (control_allowed) {
                    var old_move = control.move;

                    if (control.right) {
                        if (control.up) {
                            control.move = [% MOVE_RU %];
                        }
                        else if (control.down) {
                            control.move = [% MOVE_RD %];
                        }
                        else {
                            control.move = [% MOVE_R %];
                        }
                    }
                    else if (control.left) {
                        if (control.up) {
                            control.move = [% MOVE_LU %];
                        }
                        else if (control.down) {
                            control.move = [% MOVE_LD %];
                        }
                        else {
                            control.move = [% MOVE_L %];
                        }
                    }
                    else if (control.up) {
                        control.move = [% MOVE_U %];
                    }
                    else if (control.down) {
                        control.move = [% MOVE_D %];
                    }
                    else {
                        control.move = [% MOVE_IDLE %];
                    }

                    if (old_move != control.move) {
                        send_msg({type: 'move', 'move': control.move});
                    }
                }
            }

            function update_person_control(dt) {
                // console.log(rotating, control);
                if (control_allowed) {
                    var old_move = control.move;
                    if (control.right) {
                        control.move = [% MOVE_R %];
                    }
                    else if (control.left) {
                        control.move = [% MOVE_L %];
                    }
                    else {
                        control.move = [% MOVE_IDLE %];
                    }

                    if (old_move != control.move) {
                        send_msg({type: 'move', 'move': control.move});
                    }

                    if (control.up) {
                        send_msg({type: 'move', 'move': [% MOVE_U %]});
                    }
                }
            }

            var ship_shapes = {};
            function create_ship_shape(ship) {
                var shape = new createjs.Shape();
                switch (ship.type) {
                    case 'station':
                        shape.graphics.s("white").f("lightblue").dc(0, 0, 100);
                        shape.graphics.s("white").f("dimgray").dc(80, 0, 18);
                    break;
                    default:
                        shape.graphics.s("white").f("lightgray").mt(10, 0).lt(-10, -5).lt(-10, 5).cp();
                }
                return shape;
            }
            function get_ship_shape(id, ship) {
                if (!ship_shapes[id]) {
                    ship_shapes[id] = create_ship_shape(ship);
                    ships_container.addChild(ship_shapes[id]);
                }
                return ship_shapes[id];
            }
            var person_shapes = {};
            function create_person_shape(person) {
                var shape = new createjs.Shape();
                shape.graphics.s("white").mt(-4, 0).lt(0, -10).lt(4, 0).mt(0, -10).lt(0, -18).lt(-4, -10).mt(0, -18).lt(4, -10).f("orange").dc(0, -20, 3);
                return shape;
            }
            function get_person_shape(id, person) {
                if (!person_shapes[id]) {
                    person_shapes[id] = create_person_shape(person);
                    people_container.addChild(person_shapes[id]);
                }
                return person_shapes[id];
            }

            function draw_objects() {
                for (var i in objects) {
                    var object = objects[i];
                    var shape = new createjs.Shape();
                    shape.graphics.s("white").mt(object.geometry.left, object.geometry.y).lt(object.geometry.right, object.geometry.y);
                    objects_container.addChild(shape);
                }
            }

            var stage;
            var control_container;
            var timer_shape;
            var ships_container;
            var people_container;
            var objects_container;
            var projections_shape;
            var control_projection_shape;
            function init_game(canvas_id) {
                canvas = $('#' + canvas_id);
                screen_width = $(document).width();
                screen_height = $(document).height() - 24;
                canvas.attr( 'width',  screen_width );
                canvas.attr( 'height', screen_height );
                stage = new createjs.Stage(canvas_id);

                projections_shape = new createjs.Shape();
                stage.addChild(projections_shape);

                control_projection_shape = new createjs.Shape();
                stage.addChild(control_projection_shape);

                objects_container = new createjs.Container();
                stage.addChild(objects_container);

                ships_container = new createjs.Container();
                stage.addChild(ships_container);

                people_container = new createjs.Container();
                stage.addChild(people_container);

                control_container = new createjs.Container();
                stage.addChild(control_container);
                // control_shape = new createjs.Shape();
                // control_container.addChild(control_shape);
                // control_shape.graphics.s("lightblue").mt(10, 0).lt(-10, -5).lt(-10, 5).cp();

                createjs.Ticker.interval = 30;
                createjs.Ticker.addEventListener("tick", function(event) {
                    // console.log(event);
                    if (!event.paused) {
                        if (zone_type == 'space') {
                            update_ships(event.delta / 1000);
                        }
                        else if (zone_type == 'station') {
                            update_people(event.delta / 1000);
                        }
                        stage.update(event);
                    }
                });

                this.document.onkeydown = function(event) {
                    switch (event.code) {
                        case 'ArrowUp':
                            control.up = true;
                        break;
                        case 'ArrowDown':
                            control.down = true;
                        break;
                        case 'ArrowLeft':
                            control.left = true;
                        break;
                        case 'ArrowRight':
                            control.right = true;
                        break;
                        case 'Space':
                            for (var id in ships) {
                                var ship = ships[id];
                                if (ship.type != 'station') {
                                    continue;
                                }
                                var my_ship = ships['player_' + my_id];
                                var dx = my_ship.x - ship.x;
                                var dy = my_ship.y - ship.y;
                                var distance = Math.sqrt( Math.pow(dx, 2) + Math.pow(dy, 2) );
                                if (distance > 100) {
                                    continue;
                                }
                                send_msg({type: 'dock', to: id});
                                break;
                            };
                        break;
                    }
                    update_control();
                }
                this.document.onkeyup = function(event) {
                    switch (event.code) {
                        case 'ArrowUp':
                            control.up = false;
                        break;
                        case 'ArrowDown':
                            control.down = false;
                        break;
                        case 'ArrowLeft':
                            control.left = false;
                        break;
                        case 'ArrowRight':
                            control.right = false;
                        break;
                    }
                    update_control();
                }
            }
        </script>
    </head>
    <body style="background-color:#CCC;margin: 0px">
        <canvas id="game-canvas" style="background:black;">
            alternate content
        </canvas>

        Connection Status:
        <span id="connection-status"> Disconnected </span>
    </body>
</html>